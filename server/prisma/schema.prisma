// SchÃ©ma Prisma pour Virtual World
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  coins     Int      @default(1000)
  gems      Int      @default(0)
  level     Int      @default(1)
  experience Int     @default(0)
  motto     String   @default("Je suis nouveau!")
  avatar    Json     @default("{\"gender\":\"male\",\"headType\":1,\"hairStyle\":1,\"clothingStyle\":1,\"skinColor\":\"light\",\"hairColor\":\"brown\",\"clothingColor\":\"blue\",\"pantsColor\":\"blue\"}")
  isAdmin   Boolean  @default(false)
  
  // âœ… Couleurs d'avatar
  avatarSkinColor  String @default("#FFDCB1")  // Beige clair
  avatarHairColor  String @default("#654321")  // Brun
  avatarShirtColor String @default("#130a01ff")  // Brun foncÃ©
  avatarPantsColor String @default("#9c702dff")  // Brun pale
  
  // âœ… NOUVEAU: Badge actif affichÃ© sur le profil
  activeBadgeId String?
  
  // âœ… Badges et dates
  badges      UserBadge[]
  activeBadge Badge?    @relation("ActiveBadge", fields: [activeBadgeId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLogin   DateTime  @default(now())
  
  // âœ… Relations
  ownedRooms Room[]   @relation("RoomOwner")
  messages   Message[]
  userQuests UserQuest[]
  
  @@index([username])
  @@index([coins(sort: Desc)])
}

model Room {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  ownerId     String
  isPublic    Boolean  @default(true)
  maxUsers    Int      @default(25)
  password    String?
  
  // Layout et dÃ©coration
  layout      String   @default("basic")
  furnitures  Json     @default("[]")
  wallpaper   String   @default("default")
  floor       String   @default("default")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  owner       User     @relation("RoomOwner", fields: [ownerId], references: [id])
  messages    Message[]
  
  @@index([isPublic])
  @@index([ownerId])
}

model Message {
  id        String   @id @default(uuid())
  content   String
  userId    String
  roomId    String
  type      String   @default("chat") // chat, whisper, system
  
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@index([userId])
  @@index([createdAt])
}

model Economy {
  id          String   @id @default(uuid())
  totalCoins  BigInt   @default(0)
  totalGems   BigInt   @default(0)
  
  updatedAt   DateTime @updatedAt
}

//âœ… ===== SYSTÃˆME DE QUÃŠTES =====

model Quest {
  id          String    @id @default(uuid())
  name        String
  description String
  type        QuestType // TUTORIAL, DAILY, WEEKLY, SPECIAL, HIDDEN
  category    String    // "social", "decoration", "exploration", "time"
  
  // Objectifs
  targetType  String    // "send_messages", "place_furniture", "visit_rooms", etc.
  targetCount Int       // Combien de fois il faut faire l'action
  
  // RÃ©compenses
  xpReward    Int       @default(0)
  coinsReward Int       @default(0)
  itemReward  String?   // ID ou type du meuble rÃ©compense (optionnel)
  badgeReward String?   // Nom du badge Ã  donner (optionnel)
  
  // Timing & Reset
  resetTime   ResetTime // NEVER, DAILY, WEEKLY, MONTHLY
  
  // Ordre pour quÃªtes tutorial (optionnel)
  order       Int?
  
  // Activation
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  userQuests  UserQuest[]
  
  @@index([type])
  @@index([isActive])
  @@unique([name])
}

model UserQuest {
  id          String    @id @default(uuid())
  userId      String
  questId     String
  
  // Progression
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  
  // Pour daily/weekly reset
  lastReset   DateTime?
  metadata    Json?     @default("{}")
  
  // RÃ©compense rÃ©clamÃ©e
  rewardClaimed Boolean @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest       Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  @@unique([userId, questId])
  @@index([userId])
  @@index([questId])
  @@index([completed])
}

// ===== ENUMS =====

enum QuestType {
  TUTORIAL  // QuÃªtes pour dÃ©butants (une seule fois)
  DAILY     // QuÃªtes quotidiennes (reset chaque jour)
  WEEKLY    // QuÃªtes hebdomadaires (reset chaque semaine)
  SPECIAL   // QuÃªtes d'Ã©vÃ©nements (saisonniÃ¨res)
  HIDDEN    // Achievements cachÃ©s
}

enum ResetTime {
  NEVER   // QuÃªte unique (tutorial, hidden)
  DAILY   // Reset chaque jour Ã  minuit
  WEEKLY  // Reset chaque lundi
  MONTHLY // Reset le 1er du mois
}

// ============================================
// âœ… SYSTÃˆME DE BADGES
// ============================================

model Badge {
  id          String   @id @default(uuid())
  key         String   @unique // Ex: "first_login", "level_10", "chat_master"
  name        String   // Ex: "Premier Pas"
  description String   // Ex: "Connectez-vous pour la premiÃ¨re fois"
  icon        String   // Ex: "ðŸ‘‹" (emoji temporaire) ou "/assets/badges/first_login.png" (image finale)
  category    String   // Ex: "welcome", "progression", "social", "special"
  rarity      String   @default("common") // "common", "rare", "epic", "legendary"
  createdAt   DateTime @default(now())
  
  // Relations
  userBadges    UserBadge[]
  activeForUsers User[]  @relation("ActiveBadge")
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  badgeId     String
  unlockedAt  DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId]) // Un utilisateur ne peut dÃ©bloquer un badge qu'une fois
}
