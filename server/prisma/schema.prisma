// ==========================================
// ğŸ¯ SCHEMA PRISMA COMPLET - UWORLD
// Combine: Ancien systÃ¨me + Admin systÃ¨me
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ğŸ‘¤ MODÃˆLE USER (MEGA COMPLET)
// ==========================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  
  // ğŸ’° Ã‰conomie
  coins     Int      @default(1000)
  gems      Int      @default(0)
  
  // ğŸ“Š ExpÃ©rience & Level
  level     Int      @default(1)
  experience Int     @default(0)
  
  // ğŸ“ Profil
  motto     String   @default("Je suis nouveau!")
  avatar    Json     @default("{\"gender\":\"male\",\"headType\":1,\"hairStyle\":1,\"clothingStyle\":1,\"skinColor\":\"light\",\"hairColor\":\"brown\",\"clothingColor\":\"blue\",\"pantsColor\":\"blue\"}")
  
  // ğŸ¨ Couleurs d'avatar
  avatarSkinColor  String @default("#FFDCB1")
  avatarHairColor  String @default("#654321")
  avatarShirtColor String @default("#130a01ff")
  avatarPantsColor String @default("#9c702dff")
  
  // ğŸ… Badge actif
  activeBadgeId String?
  
  // â° Dates
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLogin   DateTime  @default(now())
  
  // ğŸ‘‘ SYSTÃˆME ADMIN
  role          String    @default("user")  // user, vip, room_designer, community_manager, moderator, admin, owner
  
  // ğŸš« Bannissement
  isBanned      Boolean   @default(false)
  banExpiresAt  DateTime?
  banReason     String?
  
  // ğŸ”‡ Mute
  isMuted       Boolean   @default(false)
  muteExpiresAt DateTime?
  muteReason    String?
  
  // âš ï¸ Avertissements
  warnings      Int       @default(0)
  
  // ğŸ‘» Mode invisible
  isInvisible   Boolean   @default(false)
  
  // ANCIEN (pour compatibilitÃ©)
  isAdmin   Boolean  @default(false)
  
  // ğŸ”— Relations
  badges           UserBadge[]
  activeBadge      Badge?              @relation("ActiveBadge", fields: [activeBadgeId], references: [id])
  ownedRooms       Room[]              @relation("RoomOwner")
  messages         Message[]
  userQuests       UserQuest[]
  sentMessages     PrivateMessage[]    @relation("SentMessages")
  receivedMessages PrivateMessage[]    @relation("ReceivedMessages")
  adminLogs        AdminLog[]          @relation("AdminActions")
  targetLogs       AdminLog[]          @relation("TargetUser")
  roomEdits        RoomEdit[]
  
  @@index([username])
  @@index([email])
  @@index([role])
  @@index([isBanned])
  @@index([coins(sort: Desc)])
}

// ==========================================
// ğŸ›ï¸ MODÃˆLE ROOM
// ==========================================

model Room {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  ownerId     String
  isPublic    Boolean  @default(true)
  maxUsers    Int      @default(25)
  password    String?
  
  // ğŸ¨ Layout et dÃ©coration
  layout      String   @default("basic")
  furnitures  Json     @default("[]")
  wallpaper   String   @default("default")
  floor       String   @default("default")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // ğŸ”— Relations
  owner       User        @relation("RoomOwner", fields: [ownerId], references: [id])
  messages    Message[]
  edits       RoomEdit[]
  
  @@index([isPublic])
  @@index([ownerId])
}

// ==========================================
// ğŸ’¬ MODÃˆLE MESSAGE
// ==========================================

model Message {
  id        String   @id @default(uuid())
  content   String
  userId    String
  roomId    String
  type      String   @default("chat") // chat, whisper, system
  
  createdAt DateTime @default(now())
  
  // ğŸ”— Relations
  user      User     @relation(fields: [userId], references: [id])
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// ğŸ“¨ MODÃˆLE PRIVATEMESSAGE
// ==========================================

model PrivateMessage {
  id         String   @id @default(uuid())
  content    String
  senderId   String
  receiverId String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("private_messages")
}

// ==========================================
// ğŸ¯ MODÃˆLE QUEST
// ==========================================

model Quest {
  id          String    @id @default(uuid())
  name        String    @unique
  description String
  type        QuestType
  category    String    // "social", "decoration", "exploration", "time"
  
  // ğŸ¯ Objectifs
  targetType  String    // "send_messages", "place_furniture", etc.
  targetCount Int
  
  // ğŸ RÃ©compenses
  xpReward    Int       @default(0)
  coinsReward Int       @default(0)
  itemReward  String?
  badgeReward String?
  
  // ğŸ”„ Reset
  resetTime   ResetTime
  order       Int?
  
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ğŸ”— Relations
  userQuests  UserQuest[]
  
  @@index([type])
  @@index([isActive])
}

model UserQuest {
  id          String    @id @default(uuid())
  userId      String
  questId     String
  
  // ğŸ“Š Progression
  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  
  // ğŸ”„ Reset
  lastReset   DateTime?
  metadata    Json?     @default("{}")
  
  // ğŸ RÃ©compense
  rewardClaimed Boolean @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // ğŸ”— Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest       Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  @@unique([userId, questId])
  @@index([userId])
  @@index([questId])
  @@index([completed])
}

// ==========================================
// ğŸ… MODÃˆLE BADGE
// ==========================================

model Badge {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String
  icon        String
  category    String
  rarity      String   @default("common")
  
  // ğŸ‘‘ ADMIN
  isAdminOnly Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  // ğŸ”— Relations
  userBadges     UserBadge[]
  activeForUsers User[]      @relation("ActiveBadge")
  
  @@index([key])
  @@index([category])
  @@index([isAdminOnly])
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  badgeId     String
  unlockedAt  DateTime @default(now())
  
  // ğŸ‘‘ ADMIN: Qui a donnÃ© le badge?
  givenBy     String?
  givenAt     DateTime @default(now())
  
  // ğŸ”— Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([givenBy])
}

// ==========================================
// ğŸ‘‘ MODÃˆLE ADMINLOG
// ==========================================

model AdminLog {
  id           String   @id @default(uuid())
  adminId      String
  targetUserId String?
  action       String   // ban, unban, mute, unmute, kick, give_badge, etc.
  reason       String?
  details      Json?
  createdAt    DateTime @default(now())
  
  admin        User     @relation("AdminActions", fields: [adminId], references: [id])
  targetUser   User?    @relation("TargetUser", fields: [targetUserId], references: [id])
  
  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
}

// ==========================================
// ğŸ›ï¸ MODÃˆLE ROOMEDIT
// ==========================================

model RoomEdit {
  id        String   @id @default(uuid())
  roomId    String
  adminId   String
  changes   Json
  createdAt DateTime @default(now())
  
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  admin     User     @relation(fields: [adminId], references: [id])
  
  @@index([roomId])
  @@index([adminId])
  @@index([createdAt])
}

// ==========================================
// ğŸ’° MODÃˆLE ECONOMY
// ==========================================

model Economy {
  id          String   @id @default(uuid())
  totalCoins  BigInt   @default(0)
  totalGems   BigInt   @default(0)
  updatedAt   DateTime @updatedAt
}

// ==========================================
// ğŸ“‹ ENUMS
// ==========================================

enum QuestType {
  TUTORIAL
  DAILY
  WEEKLY
  SPECIAL
  HIDDEN
}

enum ResetTime {
  NEVER
  DAILY
  WEEKLY
  MONTHLY
}
